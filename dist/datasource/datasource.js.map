{"version":3,"sources":["../../src/datasource/datasource.js"],"names":[],"mappings":"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","file":"datasource.js","sourcesContent":["\nimport moment from 'moment';\nimport {StreamHandler} from './stream_handler';\n\nexport class SnapDatasource {\n\n  constructor(instanceSettings, $http, backendSrv)  {\n    this.instanceSettings = instanceSettings;\n    this.url = instanceSettings.url;\n    this.$http = $http;\n    this.backendSrv = backendSrv;\n    this.streamHandlers = {};\n  }\n\n  request(options) {\n    options.url = this.url + options.url;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  getTasks() {\n    return this.request({method: 'get', url: '/v1/tasks'}).then(res => {\n      if (!res.data || !res.data.body || !res.data.body.ScheduledTasks) {\n        return [];\n      }\n\n      return res.data.body.ScheduledTasks;\n    });\n  }\n\n  emptyResult() {\n    return Promise.resolve({data: []});\n  }\n\n  getTask(taskId) {\n    return this.request({method: 'get', url: '/v1/tasks/' + taskId}).then(res => {\n      return res.data.body;\n    }).catch(err => {\n      if (err.status === 404) {\n        return null;\n      } else {\n        throw err;\n      }\n    });\n  }\n\n  createTask(target) {\n    if (target.metrics.length === 0) {\n      return Promise.reject(\"No metrics selected for task\");\n    }\n\n    var task = {\n      version: 1,\n      name: target.taskName,\n      start: true,\n      schedule: {\n        type: 'simple',\n        interval: target.interval,\n      },\n      workflow: {\n        collect: {\n        }\n      },\n      publish: []\n    };\n\n    task.workflow.collect.metrics = target.metrics.reduce((memo, metric) => {\n      memo[metric.namespace] = {};\n      return memo;\n    }, {});\n\n    console.log('creating task', task);\n    return this.request({method: 'post', url: '/v1/tasks', data: task}).then(res => {\n      console.log('created task', res);\n      return res.data.body;\n    });\n  }\n\n  // getTaskId(target) {\n  //   if (!target) {\n  //     return Promise.resolve(null);\n  //   }\n  //\n  //   switch (target.mode) {\n  //     case 'Watch Task': {\n  //       if (!target.taskId) {\n  //         return Promise.resolve(null);\n  //       }\n  //\n  //       return this.getTask(target.taskId).then(task => {\n  //         return task.id;\n  //       });\n  //     }\n  //     case  'Define Task': {\n  //       if (target.taskId) {\n  //         return this.getTask(target.taskId).then(task => {\n  //           return task.id;\n  //         });\n  //       }\n  //     }\n  //   }\n  // }\n\n  query(options) {\n    var handler = this.streamHandlers[options.panelId];\n    if (handler) {\n      return Promise.resolve(handler);\n    }\n\n    this.streamHandlers[options.panelId] = handler = new StreamHandler(options, this);\n    handler.start();\n\n    return Promise.resolve(handler);\n\n    // if (this.runningQuery) {\n    //   return this.runningQuery;\n    // }\n    //\n    // var target = options.targets[0];\n    // this.runningQuery = this.getTaskId(target).then(taskId => {\n    //\n    //   if (!taskId) {\n    //     return this.emptyResult();\n    //   }\n    //\n    //   var watchUrl = this.url + '/v1/tasks/' + taskId + '/watch';\n    //   this.observable = Observable.create(observer => {\n    //\n    //     var handler = new StreamHandler();\n    //     handler.start(observer, watchUrl);\n    //\n    //     return () => {\n    //       handler.close();\n    //       this.observable = null;\n    //     };\n    //   });\n    //\n    //   return this.observable;\n    // }).finally(() => {\n    //   this.runningQuery = null;\n    // });\n    //\n    // return this.runningQuery;\n  }\n\n  getMetrics() {\n    if (this.metricsCache) {\n      return Promise.resolve(this.metricsCache);\n    }\n\n    return this.request({method: 'get', url: '/v1/metrics'}).then(res => {\n      if (!res.data || !res.data.body || !res.data.body) {\n        return [];\n      }\n\n      this.metricsCache = res.data.body.map(value => {\n        return {text: value.namespace, value: value.namespace};\n      });\n\n      return this.metricsCache;\n    });\n  }\n\n  deleteTask(taskId) {\n    return this.request({method: 'delete', url: '/v1/tasks/' + taskId});\n  }\n\n  startTask(taskId) {\n    return this.request({method: 'put', url: '/v1/tasks/' + taskId + '/start'});\n  }\n\n  stopTask(taskId) {\n    return this.request({method: 'put', url: '/v1/tasks/' + taskId + '/stop'});\n  }\n\n}\n\n"]}