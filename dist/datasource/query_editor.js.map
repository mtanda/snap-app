{"version":3,"sources":["../../src/datasource/query_editor.js"],"names":[],"mappings":"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","file":"query_editor.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\n\nimport _ from 'lodash';\n\nclass SnapQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.removeMetricOption = this.uiSegmentSrv.newSegment({fake: true, value: '-- remove metric --'});\n\n    this.target.taskName = this.target.taskName || 'select task';\n    this.target.taskId = this.target.taskId || '';\n    this.target.metrics = this.target.metrics || [];\n    this.target.interval = this.target.interval || '1s';\n\n    this.taskSegment = this.uiSegmentSrv.newSegment({\n      value: this.target.taskName,\n      cssClass: \"tight-form-item-xxlarge\",\n    });\n\n    if (this.target.taskName === 'select task') {\n      this.taskSegment.fake = true;\n    }\n\n    this.metricSegments = this.target.metrics.map(item => {\n      return this.uiSegmentSrv.newSegment({value: item.namespace, cssClass: 'last'});\n    });\n\n    this.metricSegments.push(this.uiSegmentSrv.newPlusButton());\n    this.getTaskInfo();\n  }\n\n  getTasks() {\n    return this.datasource.getTasks().then(tasks => {\n      this.taskMap = {};\n\n      return tasks.map(task => {\n        this.taskMap[task.name] = task;\n\n        return this.uiSegmentSrv.newSegment({value: task.name});\n      });\n    });\n  }\n\n  taskChanged() {\n    var task = this.taskMap[this.taskSegment.value];\n    if (task) {\n      this.target.taskName = task.name;\n      this.target.taskId = task.id;\n      this.getTaskInfo();\n    } else {\n      task.target.taskId = '';\n    }\n  }\n\n  getMetricSegments(segment) {\n    return this.datasource.getMetrics().then(metrics => {\n      var elements = metrics.map(item => {\n        return this.uiSegmentSrv.newSegment({value: item.value});\n      });\n\n      if (!segment.fake) {\n        elements.unshift(_.clone(this.removeMetricOption));\n      }\n\n      return elements;\n    });\n  }\n\n  metricSegmentChanged(segment, index) {\n    if (segment.value === this.removeMetricOption.value) {\n      this.metricSegments.splice(index, 1);\n    } else {\n      if (segment.type === 'plus-button') {\n        segment.type = '';\n      }\n\n      if ((index+1) === this.metricSegments.length) {\n        this.metricSegments.push(this.uiSegmentSrv.newPlusButton());\n      }\n    }\n\n    this.target.metrics = this.metricSegments.reduce((memo, item) => {\n      if (!item.fake) {\n        memo.push({namespace: item.value});\n      }\n      return memo;\n    }, []);\n  }\n\n  deleteTask() {\n    this.datasource.deleteTask(this.target.taskId).then(() =>  {\n      this.target.taskId = null;\n      this.target.taskName = \"\";\n      this.taskSegment.value = 'select task';\n      this.taskSegment.html = 'select task';\n      this.taskSegment.fake = true;\n      this.taskNotFound = true;\n      this.task = null;\n      this.isRunning = false;\n    });\n  }\n\n  createTask() {\n    this.datasource.createTask(this.target).then(task =>  {\n      this.target.taskId = task.id;\n      this.getTaskInfo();\n    });\n  }\n\n  getTaskInfo() {\n    if (!this.target.taskId) {\n      this.taskNotFound = true;\n      return;\n    }\n\n    this.datasource.getTask(this.target.taskId).then(task =>  {\n      if (!task) {\n        this.task = null;\n        this.target.taskId = '';\n        this.taskNotFound = true;\n        return;\n      }\n      this.taskNotFound = false;\n      this.task = task;\n      this.isRunning = task.task_state === 'Running';\n      this.isStopped = task.task_state === 'Stopped';\n    });\n  }\n\n  startTask() {\n    this.datasource.startTask(this.target.taskId)\n      .then(this.getTaskInfo.bind(this));\n  }\n\n  stopTask() {\n    this.panelCtrl.dataStream.stop();\n    this.datasource.stopTask(this.target.taskId)\n      .then(this.getTaskInfo.bind(this));\n  }\n\n  watchTask() {\n    this.panelCtrl.dataStream.start();\n  }\n}\n\nSnapQueryCtrl.templateUrl = 'datasource/query_editor.html';\nexport {SnapQueryCtrl};\n"]}